name: Download YouTube Video

on:
  repository_dispatch:
    types: [download_video]

jobs:
  download:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install yt-dlp
        run: |
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
      
      - name: Download video
        id: download
        run: |
          URL="${{ github.event.client_payload.url }}"
          echo "Downloading: $URL"
          
          # Download video with audio in best quality
          yt-dlp -f "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best" \
            --merge-output-format mp4 \
            --output "video.%(ext)s" \
            "$URL"
          
          # Get the downloaded filename
          FILENAME=$(ls -1 video.* | head -n 1)
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: video-download
          path: video.*
          retention-days: 2

